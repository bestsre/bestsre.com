<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.55.6" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>kubeadm部署kubernetes集群 | Dark404</title>
    <meta property="og:title" content="kubeadm部署kubernetes集群 - Dark404">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content="2018-11-10T11:33:24&#43;08:00">
        
        
    <meta property="article:modified_time" content="2018-11-10T11:33:24&#43;08:00">
        
    <meta name="Keywords" content="Golang,Ops,Kuberentes,Linux,DevOps,Docker,SRE">
    <meta name="description" content="kubeadm部署kubernetes集群">
        
    <meta name="author" content="Dark404">
    <meta property="og:url" content="https://www.bestsre.com/post/Use-kubeadm-build-kubernetes-cluster/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/css/normalize.css">
    
        <link rel="stylesheet" href="/css/prism.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

    


    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://www.bestsre.com">
                        Dark404
                    </a>
                
                <p class="description">自性本心 明心见性</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://www.bestsre.com">首页</a>
                    
                    <a  href="https://www.bestsre.com/archives/" title="归档">归档</a>
                    
                    <a  href="https://www.bestsre.com/books/" title="电子书">电子书</a>
                    
                    <a  href="https://www.bestsre.com/about/" title="关于">关于</a>
                    
                    <a  href="https://www.bestsre.com" title=""></a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title">kubeadm部署kubernetes集群</h1>
                        </header>
                        <date class="post-meta meta-date">
                            2018年11月10日
                        </date>
                        
                        <div class="post-meta">
                            <span>|</span>
                            
                                <span class="meta-category"><a href="https://www.bestsre.com/categories/Kubernetes">Kubernetes</a></span>
                            
                        </div>
                        
                        
                        <div class="post-meta">
                            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span> 阅读</span></span>
                        </div>
                        
                        
                        <div class="clear">
                            <div class="toc-article">
                                <div class="toc-title">文章目录</div>
                                <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#系统环境准备">系统环境准备</a>
<ul>
<li><a href="#环境">环境</a></li>
<li><a href="#系统配置">系统配置</a></li>
</ul></li>
<li><a href="#使用kubeadm部署kubernetes">使用kubeadm部署Kubernetes</a>
<ul>
<li><a href="#安装kubeadm和kubelet">安装kubeadm和kubelet</a></li>
<li><a href="#使用kubeadm-init初始化集群">使用kubeadm init初始化集群</a></li>
<li><a href="#部署网络插件">部署网络插件</a></li>
<li><a href="#部署worker节点">部署worker节点</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
                            </div>
                        </div>
                        
                        <div class="post-content">
                            

<p>kubeadm是Kubernetes官方提供的用于快速安装Kubernetes集群的工具，伴随Kubernetes每个版本的发布都会同步更新，kubeadm会对集群配置方面的一些实践做调整，通过实验kubeadm可以学习到Kubernetes官方在集群配置上一些新的最佳实践。</p>

<p>在Kubernetes的文档<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">Creating a single master cluster with kubeadm</a>中已经给出了目前kubeadm的主要特性已经处于beta状态了，在2018年将进入GA状态，说明kubeadm离可以在生产环境中使用的距离越来越近了。</p>

<p>当然我们线上稳定运行的Kubernetes集群是使用ansible以二进制形式的部署的高可用集群，这里体验Kubernetes 1.12中的kubeadm是为了跟随官方对集群初始化和配置方面的最佳实践，进一步完善我们的ansible部署脚本。</p>

<h2 id="系统环境准备">系统环境准备</h2>

<h3 id="环境">环境</h3>

<table>
<thead>
<tr>
<th>ip</th>
<th>hostname</th>
<th>OS</th>
<th>k8s-role</th>
</tr>
</thead>

<tbody>
<tr>
<td>192.168.2.45</td>
<td>k8s-master-45</td>
<td>centos 7</td>
<td>master</td>
</tr>

<tr>
<td>192.168.2.46</td>
<td>k8s-work-46</td>
<td>centos7</td>
<td>work</td>
</tr>

<tr>
<td>192.168.2.47</td>
<td>k8s-work-47</td>
<td>centos7</td>
<td>work</td>
</tr>
</tbody>
</table>

<h3 id="系统配置">系统配置</h3>

<p><strong>hosts</strong></p>

<pre><code class="language-bash">cat /etc/hosts
192.168.2.45 k8s-master-45
192.168.2.46 k8s-work-46
192.168.2.47 k8s-work-47
</code></pre>

<p><strong>禁用selinux,firewalld</strong></p>

<pre><code class="language-bash"># 禁用selinux
vi /etc/selinux/config
SELINUX=disabled
# 禁用firewalld
systemctl stop firewalld
systemctl disable firewalld
</code></pre>

<p><strong>内核配置</strong><br />
配置网桥参数，使得流量不会绕过<code>iptable</code></p>

<pre><code class="language-bash"># vim /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
# modprobe br_netfilter
# sysctl -p /etc/sysctl.d/k8s.conf
</code></pre>

<p><strong>禁用swap</strong></p>

<pre><code class="language-bash">swapoff -a # 临时
# 永久，注释swap相关
vim /etc/fstab
#/dev/mapper/centos-swap swap                    swap    defaults        0 0
mount -a
reboot
</code></pre>

<p><strong>安装docker-ce</strong></p>

<blockquote>
<p>需要注意的是，Kubernetes 1.12已经针对Docker的1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06等版本做了验证，最低支持的Docker版本是1.11.1，最高支持是18.06，Docker最新版本已经是18.09了，故我们安装时需要指定版本为18.06.1-ce</p>
</blockquote>

<p><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.12.md#external-dependencies">查看扩展组件依赖版本</a></p>

<pre><code class="language-bash">yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
yum install docker-ce-18.06.1.ce-3.el7 -y
systemctl start docker
systemctl enable docker
</code></pre>

<p><strong>调整时区</strong><br />
时区不对，时间差较大，证书验证会不通过</p>

<pre><code class="language-bash">yum install ntpdate -y
ntpdate time.windows.com
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</code></pre>

<h2 id="使用kubeadm部署kubernetes">使用kubeadm部署Kubernetes</h2>

<h3 id="安装kubeadm和kubelet">安装kubeadm和kubelet</h3>

<p>每个节点进行安装<br />
<strong>yum源</strong></p>

<pre><code class="language-bash"># google
cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg
        https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF

#aliyun
cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
</code></pre>

<p><strong>安装</strong></p>

<pre><code class="language-bash">yum install -y kubelet kubeadm kubectl ipvsadm
</code></pre>

<h3 id="使用kubeadm-init初始化集群">使用kubeadm init初始化集群</h3>

<p><strong>设置kubelet开机启动</strong></p>

<pre><code class="language-bash">systemctl enable kubelet.service
</code></pre>

<p><strong>kubeadm配置文件</strong><br />
&gt;在kubeadm v1.11+版本中，增加了一个<code>kubeadm config print-default</code>命令，可以让我们方便的将kubeadm的默认配置输出至文件中，修改成自己想要的</p>

<pre><code class="language-bash"># cat kubeadm.yaml
</code></pre>

<pre><code class="language-yaml">apiVersion: kubeadm.k8s.io/v1alpha2
kind: MasterConfiguration
controllerManagerExtraArgs:
  horizontal-pod-autoscaler-use-rest-clients: &quot;true&quot;
  horizontal-pod-autoscaler-sync-period: &quot;10s&quot;
  node-monitor-grace-period: &quot;10s&quot;
apiServerExtraArgs:
  runtime-config: &quot;api/all=true&quot;
kubernetesVersion: &quot;stable-1.12&quot; # 指定版本v1.12.2
imageRepository: registry.aliyuncs.com/google_containers # 指定阿里云的镜像库
</code></pre>

<p><strong>镜像获取</strong><br />
这种部署方式最蛋疼的地方就是拉取镜像了，主要是下面几个镜像，也可以从国内pull到本地重新打tag</p>

<pre><code class="language-bash">kubeadm config images pull --config kubeadm.yaml
</code></pre>

<pre><code class="language-bash">registry.aliyuncs.com/google_containers/kube-apiserver:v1.12.2
registry.aliyuncs.com/google_containers/kube-controller-manager:v1.12.2
registry.aliyuncs.com/google_containers/kube-scheduler:v1.12.2
registry.aliyuncs.com/google_containers/kube-proxy:v1.12.2
registry.aliyuncs.com/google_containers/pause:3.1     
registry.aliyuncs.com/google_containers/etcd:3.2.24
registry.aliyuncs.com/google_containers/coredns:1.2.2
</code></pre>

<p><strong>初始化集群</strong></p>

<pre><code class="language-bash">kubeadm init --config kubeadm.yaml
</code></pre>

<p>重新初始化可以执行</p>

<pre><code class="language-bash">kubeadm reset
</code></pre>

<p>就可以完成 Kubernetes Master 的部署了，部署完成后，kubeadm 会生成一行指令：</p>

<pre><code class="language-bash">Your Kubernetes master has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of machines by running the following on each node
as root:

  kubeadm join 192.168.2.45:6443 --token 2qncip.5p98b3zuvi9rumwk --discovery-token-ca-cert-hash sha256:3227d728428eaba7145196d66dc954a554be6a3ae2d32d088632a8561602fd48
</code></pre>

<p>这个 kubeadm join 命令，就是用来给这个 Master节点添加更多工作节点（Worker）的命令<br />
kubeadm 还会提示我们第一次使用 Kubernetes集群所需要的配置命令：</p>

<pre><code class="language-bash">mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>

<p><strong>获取当前节点状态</strong></p>

<pre><code class="language-bash">kubectl get node
NAME            STATUS     ROLES    AGE     VERSION
k8s-master-45   NotReady   master   5m13s   v1.12.2
</code></pre>

<p>NodeNotReady 的原因在于，我们尚未部署任何网络插件<br />
通过 kubectl describe 指令的输出可以看到，CoreDNS、kube-controller-manager等依赖于网络的 Pod 都处于 Pending 状态，即调度失败。这当然是符合预期的因为这个 Master 节点的网络尚未就绪.</p>

<h3 id="部署网络插件">部署网络插件</h3>

<pre><code class="language-bash">kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')&quot;
</code></pre>

<p>部署之后状态</p>

<pre><code class="language-bash">kubectl get node
NAME            STATUS   ROLES    AGE     VERSION
k8s-master-45   Ready    master   6m29s   v1.12.2
</code></pre>

<h3 id="部署worker节点">部署worker节点</h3>

<p><strong>启动kubelet</strong><br />
pause镜像</p>

<pre><code class="language-shell">sudo docker pull registry.aliyuncs.com/google_containers/pause:3.1
sudo docker tag registry.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1
</code></pre>

<p>启动kubelet</p>

<pre><code class="language-bash">sudo systemctl start kubelet
</code></pre>

<p>执行部署 Master 节点时生成的 kubeadm join 指令：</p>

<pre><code class="language-bash">kubeadm join 192.168.2.45:6443 --token 2qncip.5p98b3zuvi9rumwk --discovery-token-ca-cert-hash sha256:3227d728428eaba7145196d66dc954a554be6a3ae2d32d088632a8561602fd48
</code></pre>

<p><strong>集群状态</strong></p>

<pre><code class="language-bash">kubectl get node
NAME            STATUS   ROLES    AGE     VERSION
k8s-master-45   Ready    master   26m     v1.12.2
k8s-work-46     Ready    &lt;none&gt;   8m51s   v1.12.2
k8s-work-47     Ready    &lt;none&gt;   2m28s   v1.12.2
</code></pre>

<p>添加角色标签</p>

<pre><code class="language-bash">kubectl label node k8s-work-46 node-role.kubernetes.io/worker=worker
kubectl label node k8s-work-47 node-role.kubernetes.io/worker=worker

kubectl get node
NAME            STATUS   ROLES    AGE     VERSION
k8s-master-45   Ready    master   27m     v1.12.2
k8s-work-46     Ready    worker   10m     v1.12.2
k8s-work-47     Ready    worker   3m52s   v1.12.2
</code></pre>

                        </div>

                        


                        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/ceph-luminous-cluster/">ceph-luminous-cluster</a></li>
        
        <li><a href="/post/MongoDB-3.6-%E5%88%86%E7%89%87%E5%A4%8D%E5%88%B6%E9%9B%86%E7%BE%A4/">MongoDB 3.6分片复制集群</a></li>
        
        <li><a href="/books/"></a></li>
        
        <li><a href="/about/">About me</a></li>
        
        <li><a href="/archives/">归档</a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            <ul class="clearfix">
                                
                                <li><a href="https://www.bestsre.com/tags/Kubernetes">Kubernetes</a></li>
                                
                            </ul>
                            
                        </div>
                    </article>
                    
    

    
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://www.bestsre.com">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://www.bestsre.com/post/kubeadm%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7kubernetes%E9%9B%86%E7%BE%A4/" title="kubeadm平滑升级kubernetes集群">kubeadm平滑升级kubernetes集群</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/post/kubeadm%E9%83%A8%E7%BD%B2%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" title="kubeadm拉取谷歌镜像被墙问题解决">kubeadm拉取谷歌镜像被墙问题解决</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/post/tcpdump%E6%89%8B%E5%86%8C/" title="抓包神器tcpdump基本使用">抓包神器tcpdump基本使用</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/post/Use-kubeadm-build-kubernetes-cluster/" title="kubeadm部署kubernetes集群">kubeadm部署kubernetes集群</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/post/ceph-luminous-cluster/" title="ceph-luminous-cluster">ceph-luminous-cluster</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/post/MongoDB-3.6-%E5%88%86%E7%89%87%E5%A4%8D%E5%88%B6%E9%9B%86%E7%BE%A4/" title="MongoDB 3.6分片复制集群">MongoDB 3.6分片复制集群</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://www.bestsre.com/categories/Ceph/">Ceph(1)</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/categories/Kubernetes/">Kubernetes(3)</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/categories/Linux/">Linux(1)</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/categories/MongoDB/">MongoDB(1)</a>
    </li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="https://www.bestsre.com/tags/Ceph/">Ceph</a>
    
    <a href="https://www.bestsre.com/tags/Kubernetes/">Kubernetes</a>
    
    <a href="https://www.bestsre.com/tags/Linux/">Linux</a>
    
    <a href="https://www.bestsre.com/tags/MongoDB/">MongoDB</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://www.bestsre.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2019 <a href="https://www.bestsre.com">Dark404 By Dark404</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    <script type="text/javascript">
    
    (function(){
        $("pre code").parent().addClass("line-numbers")
    }())

    window.MathJax = {
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
        }
    };
    </script>
    <script type="text/javascript" src="/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/js/totop.js?v=0.0.0" async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129052460-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



<script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>
</html>
