<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.55.6" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>kubeadm平滑升级kubernetes集群 | 黑夜浮屠</title>
    <meta property="og:title" content="kubeadm平滑升级kubernetes集群 - 黑夜浮屠">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content="2019-03-10T11:33:24&#43;08:00">
        
        
    <meta property="article:modified_time" content="2019-03-10T11:33:24&#43;08:00">
        
    <meta name="Keywords" content="Golang,Ops,Kuberentes,Linux,DevOps,Docker,SRE">
    <meta name="description" content="kubeadm平滑升级kubernetes集群">
        
    <meta name="author" content="Galen">
    <meta property="og:url" content="https://www.bestsre.com/post/kubeadm%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7kubernetes%E9%9B%86%E7%BE%A4/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/css/normalize.css">
    
        <link rel="stylesheet" href="/css/prism.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

    


    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://www.bestsre.com">
                        黑夜浮屠
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://www.bestsre.com">首页</a>
                    
                    <a  href="https://www.bestsre.com/archives/" title="Archives">Archives</a>
                    
                    <a  href="https://www.bestsre.com/books/" title="E-book">E-book</a>
                    
                    <a  href="https://www.bestsre.com/about/" title="About">About</a>
                    
                    <a  href="https://www.bestsre.com" title=""></a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title">kubeadm平滑升级kubernetes集群</h1>
                        </header>
                        <date class="post-meta meta-date">
                            2019年3月10日
                        </date>
                        
                        <div class="post-meta">
                            <span>|</span>
                            
                                <span class="meta-category"><a href="https://www.bestsre.com/categories/Kubernetes">Kubernetes</a></span>
                            
                        </div>
                        
                        
                        <div class="post-meta">
                            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span> 阅读</span></span>
                        </div>
                        
                        
                        <div class="clear">
                            <div class="toc-article">
                                <div class="toc-title">文章目录</div>
                                <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#1-检查集群可更新到的最新正式版">1、检查集群可更新到的最新正式版</a></li>
<li><a href="#2-直接在master节点升级kubeadm-kubelet-kubectl">2、直接在master节点升级kubeadm，kubelet，kubectl</a></li>
<li><a href="#3-再次检查可以升级到哪个版本">3、再次检查可以升级到哪个版本</a></li>
<li><a href="#4-升级集群">4、升级集群</a></li>
<li><a href="#5-所有node节点升级kubeadm-kubelet-并重启kubelet">5、所有node节点升级kubeadm,kubelet，并重启kubelet</a></li>
<li><a href="#6-升级kubelet的配置">6、升级kubelet的配置</a></li>
<li><a href="#7-查看">7、查看</a></li>
<li><a href="#8-升级网络组件">8、升级网络组件</a></li>
<li><a href="#9-参考">9、参考</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
                            </div>
                        </div>
                        
                        <div class="post-content">
                            

<h3 id="1-检查集群可更新到的最新正式版">1、检查集群可更新到的最新正式版</h3>

<pre><code class="language-shell">这步需要访问google上的文件，被Wall，超时
I0215 11:50:19.097435   24591 version.go:94] could not fetch a Kubernetes version from the internet: unable to get URL &quot;https://dl.k8s.io/release/stable.txt&quot;: Get https://storage.googleapis.com/kubernetes-release/release/stable.txt: net/http: request canceled (Client.Timeout exceeded while awaiting headers)
</code></pre>

<h3 id="2-直接在master节点升级kubeadm-kubelet-kubectl">2、直接在master节点升级kubeadm，kubelet，kubectl</h3>

<pre><code class="language-shell">sudo yum install kubeadm kubelet kubectl
</code></pre>

<h3 id="3-再次检查可以升级到哪个版本">3、再次检查可以升级到哪个版本</h3>

<p>通过下面信息可以看出目前的版本是<code>v1.13.3</code>,可以升级到的最新版本是<code>v1.14.1</code></p>

<pre><code class="language-shell">$ sudo kubeadm upgrade plan

[preflight] Running pre-flight checks.
[upgrade] Making sure the cluster is healthy:
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[upgrade] Fetching available versions to upgrade to
[upgrade/versions] Cluster version: v1.13.3
[upgrade/versions] kubeadm version: v1.14.1
I0508 11:57:25.991569   31894 version.go:96] could not fetch a Kubernetes version from the internet: unable to get URL &quot;https://dl.k8s.io/release/stable.txt&quot;: Get https://dl.k8s.io/release/stable.txt: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)
I0508 11:57:25.991643   31894 version.go:97] falling back to the local client version: v1.14.1
[upgrade/versions] Latest stable version: v1.14.1
I0508 11:57:36.077088   31894 version.go:96] could not fetch a Kubernetes version from the internet: unable to get URL &quot;https://dl.k8s.io/release/stable-1.13.txt&quot;: Get https://dl.k8s.io/release/stable-1.13.txt: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)
I0508 11:57:36.077123   31894 version.go:97] falling back to the local client version: v1.14.1
[upgrade/versions] Latest version in the v1.13 series: v1.14.1

Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':
COMPONENT   CURRENT       AVAILABLE
Kubelet     3 x v1.13.3   v1.14.1

Upgrade to the latest version in the v1.13 series:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.13.3   v1.14.1
Controller Manager   v1.13.3   v1.14.1
Scheduler            v1.13.3   v1.14.1
Kube Proxy           v1.13.3   v1.14.1
CoreDNS              1.2.6     1.3.1
Etcd                 3.2.24    3.3.10

You can now apply the upgrade by executing the following command:

	kubeadm upgrade apply v1.14.1

_____________________________________________________________________
</code></pre>

<h3 id="4-升级集群">4、升级集群</h3>

<pre><code class="language-shell">sudo kubeadm upgrade apply v1.14.1
</code></pre>

<h3 id="5-所有node节点升级kubeadm-kubelet-并重启kubelet">5、所有node节点升级kubeadm,kubelet，并重启kubelet</h3>

<pre><code class="language-shell">sudo yum install -y kubeadm kubelet kubectl
sudo systemctl restart kubelet
</code></pre>

<h3 id="6-升级kubelet的配置">6、升级kubelet的配置</h3>

<pre><code class="language-shell">sudo kubeadm upgrade node config --kubelet-version v1.14.1
</code></pre>

<h3 id="7-查看">7、查看</h3>

<pre><code class="language-shell">$ kubectl get node
NAME            STATUS   ROLES    AGE    VERSION
k8s-master-45   Ready    master   167d   v1.14.1
k8s-work-46     Ready    worker   167d   v1.14.1
k8s-work-47     Ready    worker   167d   v1.14.1
</code></pre>

<h3 id="8-升级网络组件">8、升级网络组件</h3>

<pre><code class="language-shell">$ kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')&quot;
</code></pre>

<p>其他组件根据对应的yaml文件看是否需要升级</p>

<h3 id="9-参考">9、参考</h3>

<p><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-upgrade/">kubeadm-upgrade官方参考</a></p>

                        </div>

                        


                        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/kubeadm%E9%83%A8%E7%BD%B2%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/">kubeadm拉取谷歌镜像被墙问题解决</a></li>
        
        <li><a href="/post/Use-kubeadm-build-kubernetes-cluster/">kubeadm部署kubernetes集群</a></li>
        
        <li><a href="/post/tcpdump%E6%89%8B%E5%86%8C/">抓包神器tcpdump基本使用</a></li>
        
        <li><a href="/post/ceph-luminous-cluster/">ceph-luminous-cluster</a></li>
        
        <li><a href="/books/"></a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            <ul class="clearfix">
                                
                                <li><a href="https://www.bestsre.com/tags/Kubernetes">Kubernetes</a></li>
                                
                            </ul>
                            
                        </div>
                    </article>
                    
    

    
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://www.bestsre.com">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://www.bestsre.com/post/kubeadm%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7kubernetes%E9%9B%86%E7%BE%A4/" title="kubeadm平滑升级kubernetes集群">kubeadm平滑升级kubernetes集群</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/post/kubeadm%E9%83%A8%E7%BD%B2%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" title="kubeadm拉取谷歌镜像被墙问题解决">kubeadm拉取谷歌镜像被墙问题解决</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/post/tcpdump%E6%89%8B%E5%86%8C/" title="抓包神器tcpdump基本使用">抓包神器tcpdump基本使用</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/post/Use-kubeadm-build-kubernetes-cluster/" title="kubeadm部署kubernetes集群">kubeadm部署kubernetes集群</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/post/ceph-luminous-cluster/" title="ceph-luminous-cluster">ceph-luminous-cluster</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/post/MongoDB-3.6-%E5%88%86%E7%89%87%E5%A4%8D%E5%88%B6%E9%9B%86%E7%BE%A4/" title="MongoDB 3.6分片复制集群">MongoDB 3.6分片复制集群</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://www.bestsre.com/categories/Ceph/">Ceph(1)</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/categories/Kubernetes/">Kubernetes(3)</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/categories/Linux/">Linux(1)</a>
    </li>
    
    <li>
        <a href="https://www.bestsre.com/categories/MongoDB/">MongoDB(1)</a>
    </li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="https://www.bestsre.com/tags/Ceph/">Ceph</a>
    
    <a href="https://www.bestsre.com/tags/Kubernetes/">Kubernetes</a>
    
    <a href="https://www.bestsre.com/tags/Linux/">Linux</a>
    
    <a href="https://www.bestsre.com/tags/MongoDB/">MongoDB</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://www.bestsre.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2019 <a href="https://www.bestsre.com">黑夜浮屠 By Galen</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    <script type="text/javascript">
    
    (function(){
        $("pre code").parent().addClass("line-numbers")
    }())

    window.MathJax = {
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
        }
    };
    </script>
    <script type="text/javascript" src="/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/js/totop.js?v=0.0.0" async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129052460-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



<script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>
</html>
