<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="黑夜浮屠">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://bestsre.com/img/home-bg-jeep.jpg">
    <meta property="twitter:image" content="https://bestsre.com/img/home-bg-jeep.jpg" />
    

    
    <meta name="title" content="tcpdump基本使用" />
    <meta property="og:title" content="tcpdump基本使用" />
    <meta property="twitter:title" content="tcpdump基本使用" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>tcpdump基本使用-黑夜浮屠</title>

    <link rel="canonical" href="/post/tcpdump-man/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">
    
    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>



<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">黑夜浮屠</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/life">life</a>
                        </li>
                        
                        <li>
                            <a href="/categories/linux">linux</a>
                        </li>
                        
                        <li>
                            <a href="/categories/tech">tech</a>
                        </li>
                        
                        <li>
                            <a href="/categories/tips">tips</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/books/">BOOKS</a></li>
                    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/home-bg-jeep.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/linux" title="Linux">
                            Linux
                        </a>
                        
                        <a class="tag" href="/tags/tcp/ip" title="tcp/ip">
                            tcp/ip
                        </a>
                        
                    </div>
                    <h1>tcpdump基本使用</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by 
                        
                                黑夜浮屠
                         
                        on 
                        Friday, January 25, 2019
                        
                        
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h2>TOC</h2>
                </header>
                <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#tcpdump常用选项">tcpdump常用选项</a></li>
        <li><a href="#过滤数据包">过滤数据包</a></li>
        <li><a href="#怎么看输出的报文信息">怎么看输出的报文信息</a></li>
      </ul>
    </li>
  </ul>
</nav>
                
                <p>tcpdump命令最初设计用于观察TCP/IP性能问题，它是一个用于<code>截取网络分组</code>，并输出分组内容的工具。tcpdump可以将网络中传送的数据包的报文头完全截获下来提供分析，它支持针对网络层、协议、主机、网络或端口的过滤，并提供and, or, not等逻辑语句来帮助用户去掉无用的信息。抓包还是偏向于非HTTP协议，常用于服务器端，客户端可以使用wireshark，也可以使用tcpdump抓包保存数据文件，使用wireshark分析。</p>
<h2 id="tcpdump常用选项">tcpdump常用选项</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tcpdump <span style="color:#ff79c6">[</span> -AdDefIKlLnNOpqRStuUvxX <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -B buffer_size <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -c count <span style="color:#ff79c6">]</span>

	<span style="color:#ff79c6">[</span> -C file_size <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -G rotate_seconds <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -F file <span style="color:#ff79c6">]</span>
	<span style="color:#ff79c6">[</span> -i interface <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -m module <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -M secret <span style="color:#ff79c6">]</span>
	<span style="color:#ff79c6">[</span> -r file <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -s snaplen <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -T <span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -w file <span style="color:#ff79c6">]</span>
	<span style="color:#ff79c6">[</span> -W filecount <span style="color:#ff79c6">]</span>
	<span style="color:#ff79c6">[</span> -E spi@ipaddr algo:secret,... <span style="color:#ff79c6">]</span>
	<span style="color:#ff79c6">[</span> -y datalinktype <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -z postrotate-command <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> -Z user <span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span> expression <span style="color:#ff79c6">]</span>
</code></pre></div><table>
<thead>
<tr>
<th align="center">选项</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">-i</td>
<td align="center">指定抓取的网络接口<code>-i interface</code>,<code>-i any</code>可以抓取所有网络接口</td>
</tr>
<tr>
<td align="center">-D</td>
<td align="center">列出机器所有的网络接口</td>
</tr>
<tr>
<td align="center">-w</td>
<td align="center">将捕获的包数据写入到文件中，后面再进行分析；<code>-w -</code>可以进行标准输出，会出现一大串的乱码,也可以使用重定向或tee</td>
</tr>
<tr>
<td align="center">-r</td>
<td align="center">从文件中读取包数据,回放场景</td>
</tr>
<tr>
<td align="center">-c size</td>
<td align="center">指定要捕获报文数量，使用 <code>-w</code> 写入文件时,使用<code>-C</code>，限制文件的最大大小，超出时新开一个文件(单位是 1,000,000 bytes)</td>
</tr>
<tr>
<td align="center">-p</td>
<td align="center">将网卡接口设置为非混杂模式</td>
</tr>
<tr>
<td align="center">-s</td>
<td align="center">控制数据的截取长度,一般tcpdump默认为一最大字节数量并只会从单一报文中截取到该数量长度, 为 0 时表示让 tcpdump 自动选择合适的长度来抓取数据包.</td>
</tr>
<tr>
<td align="center">-S</td>
<td align="center">打印绝对序列号,一般分析数据还是使用相对的</td>
</tr>
<tr>
<td align="center">-a</td>
<td align="center">强制将网络地址显示为名称,默认的选项</td>
</tr>
<tr>
<td align="center">-n</td>
<td align="center">不要将主机地址转换为名称。这可用于避免DNS查找</td>
</tr>
<tr>
<td align="center">-nn</td>
<td align="center">不要将协议和端口号等转换为名称</td>
</tr>
<tr>
<td align="center">-N</td>
<td align="center">阻止将域名转换FQDN</td>
</tr>
<tr>
<td align="center">-f</td>
<td align="center">阻止远端名称解析</td>
</tr>
<tr>
<td align="center">-t</td>
<td align="center">不显示时间</td>
</tr>
<tr>
<td align="center">-tt</td>
<td align="center">输出时间戳</td>
</tr>
<tr>
<td align="center">-tttt</td>
<td align="center">00:00:00.000000 详细输出时间信息</td>
</tr>
<tr>
<td align="center">-v</td>
<td align="center">显示详细信息，<code>-v</code>会显示ttl信息，使用<code>-vv,-vvv</code>抓包时输出包的更多附加信息</td>
</tr>
<tr>
<td align="center">-q</td>
<td align="center">显示更少的输出信息</td>
</tr>
<tr>
<td align="center">-e</td>
<td align="center">显示链路层头信息</td>
</tr>
<tr>
<td align="center">-x</td>
<td align="center">将报文以十六进制形式dump出来，排除了链路层报文头,<code>-xx</code>增加以太网header的显示</td>
</tr>
<tr>
<td align="center">-A</td>
<td align="center">以 ASCII 码方式显示每一个数据包(不会显示数据包中链路层头部信息). 在抓取包含网页数据的数据包时, 可方便查看数据</td>
</tr>
<tr>
<td align="center">-X</td>
<td align="center">:以hex和ASCII两种形式显示包的内容,<code>-XX</code>增加以太网header的显示</td>
</tr>
</tbody>
</table>
<blockquote>
<p>混杂模式就是接收所有经过网卡的数据包，包括不是发给本机的包，即不验证MAC地址。普通模式下网卡只接收发给本机的包（包括广播包）传递给上层程序，其它的包一律丢弃。
一般来说，混杂模式不会影响网卡的正常工作，多在网络监听工具上使用。</p>
</blockquote>
<blockquote>
<p>网卡具有如下的几种工作模式：
<strong>1) 广播模式（Broad Cast Model）</strong>:它的物理地址（MAC）地址是 0Xffffff 的帧为广播帧，工作在广播模式的网卡接收广播帧。
<strong>2）多播传送（MultiCast Model）</strong>：多播传送地址作为目的物理地址的帧可以被组内的其它主机同时接收，而组外主机却接收不到。但是，如果将网卡设置为多播传送模式，它可以接收所有的多播传送帧，而不论它是不是组内成员。
<strong>3）直接模式（Direct Model）</strong>:工作在直接模式下的网卡只接收目地址是自己 Mac地址的帧。
<strong>4）混杂模式（Promiscuous Model）</strong>:工作在混杂模式下的网卡接收所有的流过网卡的帧，信包捕获程序就是在这种模式下运行的。
网卡的缺省工作模式包含广播模式和直接模式，即它只接收广播帧和发给自己的帧。如果采用混杂模式，一个站点的网卡将接受同一网络内所有站点所发送的数据包这样就可以到达对于网络信息监视捕获的目的。</p>
</blockquote>
<h2 id="过滤数据包">过滤数据包</h2>
<h3 id="过滤规则表达式">过滤规则表达式</h3>
<p>过滤规则一般包含三种修饰符的组合：</p>
<ul>
<li>type: 指定id 所代表的对象类型, id可以是名字也可以是数字. 可选的对象类型有: host, net, port 以及portrange，默认是 <code>host</code></li>
<li>dir: 描述id 所对应的传输方向, 即发往id 还是从id 接收（而id 到底指什么需要看其前面的type 修饰符）.可取的方向为: src, dst, src or dst, src and dst</li>
<li>proto: 描述id 所属的协议. 可选的协议有: ether, fddi, tr, wlan, ip, ip6, arp, rarp, decnet, tcp以及udp</li>
</ul>
<p>通过括号<code>(\( xxx \))</code> 和 bool 操作符可以组合多种过滤规则，一对括号是一组:</p>
<ul>
<li>否定操作: ! 或 not</li>
<li>与操作: &amp;&amp; 或 and</li>
<li>或操作: || 或 or</li>
</ul>
<h3 id="常用过滤规则">常用过滤规则</h3>
<h4 id="过滤地址ip域名">过滤地址ip/域名</h4>
<p><strong>过滤目标是www.baidu.com的域名:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i any -Avvv dst host www.baidu.com
</code></pre></div><p><strong>过滤源ip或目标ip是172.27.0.14:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i any -Avvv host 172.27.0.14
</code></pre></div><p><strong>过滤源ip是172.27.0.14:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i any -Avvv src 172.27.0.14
</code></pre></div><p><strong>过滤目标ip是172.27.0.14:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i any -Avvv dst host 172.27.0.14
</code></pre></div><p><strong>过滤网段，ip段：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i any net 172.17.16.0/24
sudo tcpdump -i any net 172.17.16.0 mask 255.255.255.0
</code></pre></div><h4 id="过滤端口">过滤端口</h4>
<p><strong>过滤指定端口：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -Avvv port <span style="color:#bd93f9">8888</span> -c <span style="color:#bd93f9">10</span>
</code></pre></div><p><strong>过滤源和目的端口：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -nvvv <span style="color:#f1fa8c">&#39;port 22 &amp;&amp; port 62644&#39;</span> -c <span style="color:#bd93f9">3</span>
</code></pre></div><p><strong>排除指定端口:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0  not port <span style="color:#bd93f9">22</span>
sudo tcpdump -i eth0 not <span style="color:#f1fa8c">\(</span>port <span style="color:#bd93f9">443</span> or port <span style="color:#bd93f9">80</span> or port 22<span style="color:#f1fa8c">\)</span>
</code></pre></div><p><strong>过滤端口范围:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 portrange 79-81
</code></pre></div><h4 id="过滤协议">过滤协议</h4>
<p>限制抓取指定协议,tcpdump可识别的关键字包括<code>ip</code>,<code>ip6</code>,<code>arp</code>,<code>igmp</code>,<code>tcp</code>,<code>udp</code>,<code>icmp</code>
有很多传输层服务没有可以识别的关键字。在这种情况下，可以使用关键字<code>proto</code>或ip proto加上/etc/protocols能够找到的协议名或相应的协议编号</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i macvlan0 arp
</code></pre></div><h4 id="过滤协议头">过滤协议头</h4>
<p>常用的 tcp 标记:<code>tcp-fin</code>, <code>tcp-syn</code>, <code>tcp-rst</code>, <code>tcp-push</code>, <code>tcp-ack</code>, <code>tcp-urg</code>, <code>tcp-ece</code>, <code>tcp-cwr</code></p>
<p><strong>过滤 <code>tcp SYN</code> 消息包:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 <span style="color:#f1fa8c">&#39;tcp[tcpflags] &amp; (tcp-syn) != 0&#39;</span> -c <span style="color:#bd93f9">1</span>
13:52:32.070747 IP 125.226.39.220.54500 &gt; bestsre.microsoft-ds: Flags <span style="color:#ff79c6">[</span>S<span style="color:#ff79c6">]</span>, seq 3744066256, win 8192, options <span style="color:#ff79c6">[</span>mss 1200,nop,wscale 2,sackOK,TS val <span style="color:#bd93f9">1380022</span> ecr 0<span style="color:#ff79c6">]</span>, length <span style="color:#bd93f9">0</span>
</code></pre></div><p><strong>过滤 <code>tcp SYN/ACK</code>消息包:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 <span style="color:#f1fa8c">&#39;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0&#39;</span> -c <span style="color:#bd93f9">1</span>
13:54:47.889653 IP bestsre.ssh &gt; YZ.62644: Flags <span style="color:#ff79c6">[</span>P.<span style="color:#ff79c6">]</span>, seq 4178293879:4178294067, ack 3163427986, win 314, options <span style="color:#ff79c6">[</span>nop,nop,TS val <span style="color:#bd93f9">3890058229</span> ecr 558951371<span style="color:#ff79c6">]</span>, length <span style="color:#bd93f9">188</span>
</code></pre></div><h4 id="过滤http">过滤HTTP</h4>
<p><strong>过滤 GET 请求:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -Anvvv  <span style="color:#f1fa8c">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420 and port 8888&#39;</span>
</code></pre></div><p><code>0x47455420</code> 为GET的16进制表示</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">&gt;&gt;&gt;</span> <span style="color:#8be9fd;font-style:italic">list</span>(<span style="color:#8be9fd;font-style:italic">map</span>(<span style="color:#8be9fd;font-style:italic">hex</span>, [<span style="color:#8be9fd;font-style:italic">ord</span>(x) <span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">in</span> <span style="color:#f1fa8c">&#39;GET &#39;</span>]))
[<span style="color:#f1fa8c">&#39;0x47&#39;</span>, <span style="color:#f1fa8c">&#39;0x45&#39;</span>, <span style="color:#f1fa8c">&#39;0x54&#39;</span>, <span style="color:#f1fa8c">&#39;0x20&#39;</span>]
</code></pre></div><p><strong>过滤 POST 请求:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -Anvvv <span style="color:#f1fa8c">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504f5354 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 4:1] = 0x20&#39;</span>
</code></pre></div><p><strong>过滤PUT请求:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -Anvvv <span style="color:#f1fa8c">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x50555420&#39;</span>
</code></pre></div><p><strong>过滤 PATCH 请求:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -Anvvv <span style="color:#f1fa8c">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x50415443 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 4:2] = 0x4820&#39;</span>
</code></pre></div><p><strong>过滤 DELETE 请求:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -Anvvv <span style="color:#f1fa8c">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x44454c45 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 4:2] = 0x5445 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 6:1] = 0x20&#39;</span>
</code></pre></div><p><strong>过滤 HEAD 请求:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -Anvvv <span style="color:#f1fa8c">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x48454144 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 4:1] = 0x20&#39;</span>
</code></pre></div><p><strong>过滤 OPTIONS 请求:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -Anvvv <span style="color:#f1fa8c">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x4f505449 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 4:4] = 0x4f4e5320&#39;</span>
</code></pre></div><p><strong>过滤 HTTP 响应 (HTTP/1.):</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -Anvvv <span style="color:#f1fa8c">&#39;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x48545450 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 4:2] = 0x2f31 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 6:1] = 0x2e&#39;</span>
</code></pre></div><h4 id="根据包大小过滤">根据包大小过滤</h4>
<p>数据报大小，单位是字节</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tcpdump less <span style="color:#bd93f9">32</span>
tcpdump grater <span style="color:#bd93f9">128</span>
tcpdump &gt; <span style="color:#bd93f9">32</span>
tcpdump &lt;<span style="color:#ff79c6">=</span> <span style="color:#bd93f9">128</span>
</code></pre></div><p>过滤器的更多详细信息，请访问 tcpdump 官方 map page 的 <a href="http://www.tcpdump.org/manpages/pcap-filter.7.html">PCAP-FILTER</a> 部分。</p>
<h2 id="怎么看输出的报文信息">怎么看输出的报文信息</h2>
<p>tcpdump 能够抓取并解码多种协议类型的数据报文，如 TCP、UDP、ICMP 等等。虽然这里我们不可能介绍所有的数据报文类型，但可以分析下 TCP 类型的数据报文，来帮助你入门。</p>
<p>tcpdump 抓取的 TCP 报文看起来如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo tcpdump -i eth0 -SXttttvvvnn -c <span style="color:#bd93f9">3</span>
tcpdump: listening on eth0, link-type EN10MB <span style="color:#ff79c6">(</span>Ethernet<span style="color:#ff79c6">)</span>, capture size <span style="color:#bd93f9">262144</span> bytes
2019-01-23 14:24:11.889635 IP <span style="color:#ff79c6">(</span>tos 0x10, ttl 64, id 58162, offset 0, flags <span style="color:#ff79c6">[</span>DF<span style="color:#ff79c6">]</span>, proto TCP <span style="color:#ff79c6">(</span>6<span style="color:#ff79c6">)</span>, length 176<span style="color:#ff79c6">)</span>
    172.27.0.14.22 &gt; 125.226.39.220.63970: Flags <span style="color:#ff79c6">[</span>P.<span style="color:#ff79c6">]</span>, cksum 0x488a <span style="color:#ff79c6">(</span>incorrect -&gt; 0xdcc4<span style="color:#ff79c6">)</span>, seq 2687384271:2687384395, ack 2449155490, win 314, options <span style="color:#ff79c6">[</span>nop,nop,TS val <span style="color:#bd93f9">4064622229</span> ecr 643829509<span style="color:#ff79c6">]</span>, length <span style="color:#bd93f9">124</span>
	0x0000:  <span style="color:#bd93f9">4510</span> 00b0 e332 <span style="color:#bd93f9">4000</span> <span style="color:#bd93f9">4006</span> 0f1e ac1b 000e  E....2@.@.......
	0x0010:  73ec 27d2 <span style="color:#bd93f9">0016</span> f9e2 a02e 3acf 91fb 25a2  s.&#39;.......:...%.
	0x0020:  <span style="color:#bd93f9">8018</span> 013a 488a <span style="color:#bd93f9">0000</span> <span style="color:#bd93f9">0101</span> 080a f245 <span style="color:#bd93f9">3695</span>  ...:H........E6.
	0x0030:  <span style="color:#bd93f9">2660</span> 0f05 86a8 9dad 926d 03c7 f118 6a29  &amp;<span style="color:#f1fa8c">`</span>.......m....j<span style="color:#ff79c6">)</span>
	0x0040:  28f2 03e9 aa82 00e2 7b89 3f8f ac0e 32eb  <span style="color:#ff79c6">(</span>.......<span style="color:#ff79c6">{</span>.?...2.
	0x0050:  7b56 9ce3 245f bef7 82a1 56b6 <span style="color:#bd93f9">9793</span> 3fa2  <span style="color:#ff79c6">{</span>V..<span style="color:#8be9fd;font-style:italic">$_</span>....V...?.
	0x0060:  f04c bbd7 396a <span style="color:#bd93f9">8774</span> fb66 <span style="color:#bd93f9">2683</span> <span style="color:#bd93f9">9195</span> efe3  .L..9j.t.f&amp;.....
	0x0070:  70e1 e295 c712 0b93 c168 c348 51cd 66e6  p........h.HQ.f.
	0x0080:  <span style="color:#bd93f9">9336</span> 20b0 d304 d754 3ed4 6f45 20a0 b574  .6.....T&gt;.oE...t
	0x0090:  29c4 9ac0 9d00 166a b9dd 369f 465e fc7b  <span style="color:#ff79c6">)</span>......j..6.F^.<span style="color:#ff79c6">{</span>
	0x00a0:  1f11 <span style="color:#bd93f9">4795</span> 826f 4cbb 045f 00c5 d908 1ba3  ..G..oL.._......
</code></pre></div><ul>
<li>2019-01-23 14:24:11.889635: 详细的可读时间</li>
<li>IP: ip协议，默认ipv4,如果ipv6则显示ip6</li>
<li>tos: 表示服务类型，4bit的tos分别表示最小时延，最大吞吐量，最高可靠性，最小费用。这里都是0，表示一般服务，其余4bit废用，置0</li>
<li>ttl: 数据报的生存时间,每经过一个路由器减1</li>
<li>id: 对应IP报文头的Identification,用于IP分片重组</li>
<li>offset: 用于IP分片重组，表示相对于原始未分片的报文的位置</li>
<li>flags: MF表示有更多分片，DF表示不分片，这里是DF，未使用分片，所以id和offset的值都可以忽略</li>
<li>proto: 表示协议，可以是TCP，UDP等</li>
<li>length: 总长度字段，是指整个IP数据报的长度</li>
<li>172.27.0.14.22 &gt; 125.226.39.220.63970: 表示数据是从IP为172.27.0.14端口为22发送的IP为115.236.39.210端口为63970，分别对应ip报文头的源地址、目的地址，源端口、目标端口</li>
<li>Flags: tcp报文标记段</li>
</ul>
<table>
<thead>
<tr>
<th align="center">值</th>
<th align="center">标志类型</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">S</td>
<td align="center">SYN</td>
<td align="center">Connection Start</td>
</tr>
<tr>
<td align="center">F</td>
<td align="center">FIN</td>
<td align="center">Connection Finish</td>
</tr>
<tr>
<td align="center">P</td>
<td align="center">PUSH</td>
<td align="center">Data push</td>
</tr>
<tr>
<td align="center">R</td>
<td align="center">RST</td>
<td align="center">Connection reset</td>
</tr>
<tr>
<td align="center">.</td>
<td align="center">ACK</td>
<td align="center">Acknowledgment</td>
</tr>
</tbody>
</table>
<ul>
<li>chksum: IP首部检验和和TCP报文段(包括TCP首部和数据)检验和</li>
<li>seq:  代表该数据包包含该数据流的第 2687384271 到 2687384395 字节 这里使用的是绝对序列号</li>
<li>ack: TCP是可靠连接，所以收到发送方的数据，接受方就会发送ack确认，告诉发送方，接受方已经接收到数据，否则，发送方认为数据没有发送成功，重复发送数据;如果该数据包是数据发送方，ack 值为 1，在数据接收方，该字段代表数据流上的下一个预期字节数据。</li>
<li>win: 接收窗口大小,它表示接收缓冲区中可用的字节数，后跟 TCP 选项如 MSS（最大段大小）或者窗口比例值</li>
<li>length: 代表数据包有效载荷字节长度。这个长度和 seq 序列号中字节数值长度是不一样的</li>
</ul>


                
                
<div class="entry-shang text-center">
    
	    <p>「真诚赞赏，手留余香」</p>
	
	<button class="zs show-zs btn btn-bred">赞赏支持</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">×</button>
		<span class="author"><a href="https://bestsre.com"><img src="/img/favicon.png" />黑夜浮屠</a></span>
        
	        <p class="tip"><i></i><span>真诚赞赏，手留余香</span></p>
		
 
	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2元</button>
			<button class="btn btn-blink" data-num="5">5元</button>
			<button class="btn btn-blink" data-num="10">10元</button>
			<button class="btn btn-blink" data-num="50">50元</button>
			<button class="btn btn-blink" data-num="100">100元</button>
			<button class="btn btn-blink" data-num="1">任意金额</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2元</button>
			<p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
			<img src="/img/reward/wechat-2.png"  id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
		<label><input type="radio" name="zs-type" value="wechat" class="zs-type" checked="checked"><span ><span class="zs-wechat"><img src="/img/reward/wechat-btn.png"/></span></label>
		<label><input type="radio" name="zs-type" value="alipay" class="zs-type" class="zs-alipay"><img src="/img/reward/alipay-btn.png"/></span></label>
	</div>
</div>
<script type="text/javascript" src="/js/reward.js"></script>

                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/06/04/introducing-the-istio-v1alpha3-routing-api/" data-toggle="tooltip" data-placement="top" title="Istio v1aplha3 routing API介绍(译文）">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/istio" title="istio">
                            istio
                        </a>
                        
                        
                        
                        <a href="/tags/kubernetes" title="kubernetes">
                            kubernetes
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/microservice" title="microservice">
                            microservice
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/security" title="security">
                            security
                        </a>
                        
                        
                        
                        <a href="/tags/service-mesh" title="service-mesh">
                            service-mesh
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/tips" title="tips">
                            tips
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="黑夜浮屠" >
                           <span class="fa-stack fa-lg">
                               <i class="fa fa-circle fa-stack-2x"></i>
                               <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    
                    <li>
                        <a href="mailto:youremail@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    

                    

		    
                    
                    <li>
                        <a target="_blank" href="/your%20wechat%20qr%20code%20image">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-wechat fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://github.com/yourgithub">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/yourlinkedinid">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/yourstackoverflowid">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
            
                    
                    
                    
            
            
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 黑夜浮屠 2020
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129052460-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>
</html>
